<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Collaps Chat - –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --accent-color: #667eea;
            --accent-secondary: #764ba2;
            --message-bg: #f0f2f5;
            --message-sent-bg: #667eea;
            --message-sent-text: #ffffff;
            --online-color: #4CAF50;
            --offline-color: #9E9E9E;
            --danger-color: #f44336;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 12px;
            --header-height: 60px;
            --footer-height: 70px;
        }

        /* –¢–µ–º–∞ 1: –°–≤–µ—Ç–ª–∞—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --accent-color: #667eea;
            --accent-secondary: #764ba2;
            --message-bg: #f0f2f5;
            --message-sent-bg: #667eea;
        }

        /* –¢–µ–º–∞ 2: –°–≤–µ—Ç–ª–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è */
        [data-theme="light-alt"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #e9ecef;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-secondary: #0056b3;
            --message-bg: #e9ecef;
            --message-sent-bg: #007bff;
        }

        /* –¢–µ–º–∞ 3: –¢—ë–º–Ω–∞—è */
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #242424;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #333333;
            --accent-color: #bb86fc;
            --accent-secondary: #3700b3;
            --message-bg: #2d2d2d;
            --message-sent-bg: #bb86fc;
        }

        /* –¢–µ–º–∞ 4: –¢—ë–º–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è */
        [data-theme="dark-alt"] {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --accent-secondary: #1f6feb;
            --message-bg: #21262d;
            --message-sent-bg: #1f6feb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            margin: 0 auto;
            position: relative;
            background: var(--bg-primary);
        }

        .container {
            padding: 0;
            width: 100%;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
            color: white;
            padding: 0 15px;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .username {
            font-size: 14px;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç - –ò–°–ü–†–ê–í–õ–ï–ù–û: –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ header */
        .main-content {
            padding-top: var(--header-height);
            padding-bottom: var(--footer-height);
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen {
            display: none;
            width: 100%;
            min-height: calc(100vh - var(--header-height) - var(--footer-height));
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen.active {
            display: block;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        .main-menu {
            padding: 20px 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–ù–û–ü–û–ö –ú–ï–ù–Æ */
        .menu-item {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: inherit;
            border: none;
        }

        .menu-item:hover, .menu-item:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-color: var(--accent-color);
        }

        .menu-item-icon {
            font-size: 24px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
            color: white;
            border-radius: 12px;
        }

        .menu-item-content {
            flex: 1;
        }

        .menu-item-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .menu-item-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* –§–æ—Ä–º—ã */
        .form-container {
            padding: 25px 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.1);
        }

        .form-title {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: var(--text-primary);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-full {
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* –ß–∞—Ç - –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--header-height) - var(--footer-height));
            background: var(--bg-primary);
            position: relative;
        }

        .chat-header {
            background: var(--bg-card);
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 60px;
            flex-shrink: 0;
        }

        .chat-header-title {
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .chat-header-meta {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
            min-width: 40px;
            text-align: center;
        }

        .back-btn:hover {
            background: var(--bg-secondary);
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è - –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
            position: relative;
        }

        .message {
            max-width: 85%;
            animation: messageAppear 0.3s ease;
            margin-top: 0;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            background: var(--message-bg);
            color: var(--text-primary);
            word-break: break-word;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.sent .message-content {
            background: var(--message-sent-bg);
            color: var(--message-sent-text);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .message-info {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 5px;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .chat-input-container {
            padding: 12px 16px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 10;
            height: 70px;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* –°–ø–∏—Å–∫–∏ */
        .list-container {
            padding: 16px;
        }

        .list-item {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: inherit;
            border: none;
        }

        .list-item:hover, .list-item:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }

        .list-item-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
            color: white;
            font-size: 20px;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .list-item-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .list-item-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-box {
            padding: 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-container {
            padding: 16px;
        }

        .settings-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .settings-title {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .theme-option {
            padding: 16px;
            border-radius: var(--radius);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            background: var(--bg-card);
            cursor: pointer;
            border: none;
            font-family: inherit;
            font-size: inherit;
        }

        .theme-option:hover, .theme-option:active {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.2);
        }

        .theme-preview {
            width: 64px;
            height: 42px;
            border-radius: 8px;
            overflow: hidden;
            display: grid;
            grid-template-rows: 10px 22px 10px;
            gap: 2px;
            padding: 3px;
        }

        .theme-light .theme-preview {
            background: #f5f5f5;
        }

        .theme-light-alt .theme-preview {
            background: #e9ecef;
        }

        .theme-dark .theme-preview {
            background: #1e1e1e;
        }

        .theme-dark-alt .theme-preview {
            background: #161b22;
        }

        .theme-name {
            font-size: 14px;
            font-weight: 500;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            height: var(--footer-height);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 10px 12px;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            min-width: 64px;
            cursor: pointer;
            border: none;
            background: none;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--accent-color);
            background: rgba(var(--accent-color-rgb), 0.1);
        }

        .nav-icon {
            font-size: 22px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: calc(var(--header-height) + 10px);
            right: 15px;
            left: 15px;
            padding: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--accent-color);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .confirm-modal .modal-body {
            text-align: center;
            padding: 30px 20px;
        }

        .confirm-modal .modal-footer {
            justify-content: center;
        }

        .form-modal .form-group {
            margin-bottom: 16px;
        }

        .form-modal input {
            margin-top: 4px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è –æ –ø—É—Å—Ç—ã—Ö —Å–ø–∏—Å–∫–∞—Ö */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-online {
            color: var(--online-color);
            font-size: 10px;
            margin-right: 4px;
        }

        .status-offline {
            color: var(--offline-color);
            font-size: 10px;
            margin-right: 4px;
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .p-15 { padding: 15px; }
        .hidden { display: none !important; }
        .verified-badge {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
            border-radius: 50%;
            position: relative;
            margin-left: 5px;
        }

        .verified-badge::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        /* –£–î–ê–õ–ï–ù–ê –ñ–Å–õ–¢–ê–Ø –ü–õ–ê–®–ö–ê –û –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò */

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ touch */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover, .menu-item:hover, .list-item:hover, .nav-item:hover {
                transform: none;
            }
            
            .btn:active, .menu-item:active, .list-item:active, .nav-item:active {
                transform: scale(0.98);
                opacity: 0.9;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
            }
            
            .main-menu {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .themes-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .notification {
                left: auto;
                width: 320px;
                top: calc(var(--header-height) + 20px);
                right: 20px;
            }
        }

        @media (max-width: 374px) {
            :root {
                --header-height: 50px;
                --footer-height: 60px;
            }
            
            .menu-item {
                padding: 14px;
            }
            
            .nav-item {
                min-width: 56px;
                font-size: 11px;
                padding: 8px 10px;
            }
            
            .nav-icon {
                font-size: 20px;
            }
            
            .form-container {
                padding: 20px 12px;
            }
        }

        /* –¢–µ–º—ã –¥–ª—è –ø—Ä–µ–≤—å—é */
        .theme-light .theme-preview > div:nth-child(1) {
            background: #ffffff;
        }
        .theme-light .theme-preview > div:nth-child(2) {
            background: #667eea;
        }
        .theme-light .theme-preview > div:nth-child(3) {
            background: #f5f5f5;
        }

        .theme-light-alt .theme-preview > div:nth-child(1) {
            background: #ffffff;
        }
        .theme-light-alt .theme-preview > div:nth-child(2) {
            background: #007bff;
        }
        .theme-light-alt .theme-preview > div:nth-child(3) {
            background: #e9ecef;
        }

        .theme-dark .theme-preview > div:nth-child(1) {
            background: #242424;
        }
        .theme-dark .theme-preview > div:nth-child(2) {
            background: #bb86fc;
        }
        .theme-dark .theme-preview > div:nth-child(3) {
            background: #1e1e1e;
        }

        .theme-dark-alt .theme-preview > div:nth-child(1) {
            background: #21262d;
        }
        .theme-dark-alt .theme-preview > div:nth-child(2) {
            background: #58a6ff;
        }
        .theme-dark-alt .theme-preview > div:nth-child(3) {
            background: #161b22;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –£–î–ê–õ–ï–ù–ê –ñ–Å–õ–¢–ê–Ø –ü–õ–ê–®–ö–ê –û –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò -->

        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üí¨</div>
                <span id="appTitle">Collaps Chat</span>
            </div>
            <div class="user-info">
                <span class="username" id="usernameDisplay">–ì–æ—Å—Ç—å</span>
                <button class="btn btn-small" id="themeToggleBtn" style="padding: 6px 12px; font-size: 12px;">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content">
            <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
            <div class="screen active" id="loginScreen">
                <div class="form-container">
                    <h2 class="form-title">–í—Ö–æ–¥ –≤ Collaps Chat</h2>
                    <div class="form-group">
                        <label for="loginUsername">–Æ–∑–µ—Ä–Ω–µ–π–º –∏–ª–∏ email</label>
                        <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —é–∑–µ—Ä–Ω–µ–π–º" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
                    </div>
                    <button class="btn btn-primary btn-full" id="loginBtn">–í–æ–π—Ç–∏</button>
                    <p style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 14px;">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button class="btn-link" id="showRegister" style="color: var(--accent-color); text-decoration: none; font-weight: 500; background: none; border: none; padding: 0; cursor: pointer;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </p>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="screen" id="registerScreen">
                <div class="form-container">
                    <h2 class="form-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                    <div class="form-group">
                        <label for="regUsername">–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                        <input type="text" id="regUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="regSearchUsername">–Æ–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞</label>
                        <input type="text" id="regSearchUsername" placeholder="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" placeholder="example@mail.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="regPassword" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="off">
                    </div>
                    <button class="btn btn-primary btn-full" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <p style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 14px;">
                        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <button class="btn-link" id="showLogin" style="color: var(--accent-color); text-decoration: none; font-weight: 500; background: none; border: none; padding: 0; cursor: pointer;">–í–æ–π—Ç–∏</button>
                    </p>
                </div>
            </div>

            <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
            <div class="screen" id="mainMenuScreen">
                <div class="main-menu">
                    <button class="menu-item" data-screen="globalChat">
                        <div class="menu-item-icon">üí¨</div>
                        <div class="menu-item-content">
                            <div class="menu-item-title">–û–±—â–∏–π —á–∞—Ç</div>
                            <div class="menu-item-desc">–û–±—â–∞–π—Ç–µ—Å—å —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
                        </div>
                    </button>
                    
                    <button class="menu-item" data-screen="channels">
                        <div class="menu-item-icon">üì¢</div>
                        <div class="menu-item-content">
                            <div class="menu-item-title">–ö–∞–Ω–∞–ª—ã</div>
                            <div class="menu-item-desc">–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</div>
                        </div>
                    </button>
                    
                    <button class="menu-item" data-screen="groups">
                        <div class="menu-item-icon">üë•</div>
                        <div class="menu-item-content">
                            <div class="menu-item-title">–ì—Ä—É–ø–ø—ã</div>
                            <div class="menu-item-desc">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –≥—Ä—É–ø–ø–∞—Ö</div>
                        </div>
                    </button>
                    
                    <button class="menu-item" data-screen="privateChats">
                        <div class="menu-item-icon">üí≠</div>
                        <div class="menu-item-content">
                            <div class="menu-item-title">–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã</div>
                            <div class="menu-item-desc">–û–±—â–∞–π—Ç–µ—Å—å –æ–¥–∏–Ω –Ω–∞ –æ–¥–∏–Ω</div>
                        </div>
                    </button>
                    
                    <button class="menu-item" data-screen="settings">
                        <div class="menu-item-icon">‚öôÔ∏è</div>
                        <div class="menu-item-content">
                            <div class="menu-item-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                            <div class="menu-item-desc">–¢–µ–º—ã, –ø—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –æ–±—â–µ–≥–æ —á–∞—Ç–∞ -->
            <div class="screen" id="globalChatScreen">
                <div class="chat-container">
                    <div class="chat-header">
                        <button class="back-btn" id="backFromGlobalBtn">‚Üê</button>
                        <div class="chat-header-title">üí¨ –û–±—â–∏–π —á–∞—Ç</div>
                        <div class="chat-header-meta" id="globalUsersCount">0 –æ–Ω–ª–∞–π–Ω</div>
                    </div>
                    <div class="messages" id="globalMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="globalMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button class="send-btn" id="sendGlobalMessage">‚û§</button>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –∫–∞–Ω–∞–ª–æ–≤ -->
            <div class="screen" id="channelsScreen">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchChannel" placeholder="–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–∞..." autocomplete="off">
                </div>
                <div class="list-container" id="channelsList"></div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –≥—Ä—É–ø–ø -->
            <div class="screen" id="groupsScreen">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchGroup" placeholder="–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã..." autocomplete="off">
                </div>
                <div class="list-container" id="groupsList"></div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ -->
            <div class="screen" id="privateChatsScreen">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." autocomplete="off">
                </div>
                <div class="list-container" id="usersList"></div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <div class="screen" id="settingsScreen">
                <div class="settings-container">
                    <div class="settings-section">
                        <div class="settings-title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
                        <div class="form-group">
                            <input type="text" id="changeUsername" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º">
                        </div>
                        <button class="btn btn-secondary btn-full mt-10" id="saveUsernameBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">üé® –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
                        <div class="themes-grid">
                            <button class="theme-option theme-light" data-theme="light">
                                <div class="theme-preview">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <div class="theme-name">–°–≤–µ—Ç–ª–∞—è</div>
                            </button>
                            
                            <button class="theme-option theme-light-alt" data-theme="light-alt">
                                <div class="theme-preview">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <div class="theme-name">–°–≤–µ—Ç–ª–∞—è Alt</div>
                            </button>
                            
                            <button class="theme-option theme-dark" data-theme="dark">
                                <div class="theme-preview">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <div class="theme-name">–¢—ë–º–Ω–∞—è</div>
                            </button>
                            
                            <button class="theme-option theme-dark-alt" data-theme="dark-alt">
                                <div class="theme-preview">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <div class="theme-name">–¢—ë–º–Ω–∞—è Alt</div>
                            </button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">‚öôÔ∏è –ê–∫–∫–∞—É–Ω—Ç</div>
                        <button class="btn btn-secondary btn-full mb-10" id="showAccountDataBtn">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                        <button class="btn btn-secondary btn-full mb-10" id="contactSupportBtn">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
                        <button class="btn btn-danger btn-full" id="logoutBtn">–í—ã–π—Ç–∏</button>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –∫–∞–Ω–∞–ª–∞ -->
            <div class="screen" id="channelChatScreen">
                <div class="chat-container">
                    <div class="chat-header">
                        <button class="back-btn" id="backFromChannelBtn">‚Üê</button>
                        <div class="chat-header-title" id="channelTitle">–ö–∞–Ω–∞–ª</div>
                        <div class="chat-header-meta" id="channelMembers">0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="messages" id="channelMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="channelMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button class="send-btn" id="sendChannelMessage">‚û§</button>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –≥—Ä—É–ø–ø—ã -->
            <div class="screen" id="groupChatScreen">
                <div class="chat-container">
                    <div class="chat-header">
                        <button class="back-btn" id="backFromGroupBtn">‚Üê</button>
                        <div class="chat-header-title" id="groupTitle">–ì—Ä—É–ø–ø–∞</div>
                        <div class="chat-header-meta" id="groupMembers">0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="messages" id="groupMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="groupMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button class="send-btn" id="sendGroupMessage">‚û§</button>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞ -->
            <div class="screen" id="privateChatScreen">
                <div class="chat-container">
                    <div class="chat-header">
                        <button class="back-btn" id="backFromPrivateBtn">‚Üê</button>
                        <div class="chat-header-title" id="privateChatTitle">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                    </div>
                    <div class="messages" id="privateMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="privateMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button class="send-btn" id="sendPrivateMessage">‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <button class="nav-item" data-screen="mainMenu">
                <div class="nav-icon">üè†</div>
                <div>–ì–ª–∞–≤–Ω–∞—è</div>
            </button>
            <button class="nav-item" data-screen="globalChat">
                <div class="nav-icon">üí¨</div>
                <div>–û–±—â–∏–π</div>
            </button>
            <button class="nav-item" data-screen="privateChats">
                <div class="nav-icon">üí≠</div>
                <div>–õ–∏—á–Ω—ã–µ</div>
            </button>
            <button class="nav-item" data-screen="channels">
                <div class="nav-icon">üì¢</div>
                <div>–ö–∞–Ω–∞–ª—ã</div>
            </button>
            <button class="nav-item" data-screen="settings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </button>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <div class="modal" id="accountDataModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>–î–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞</span>
                    <button class="modal-close" id="closeAccountDataBtn">&times;</button>
                </div>
                <div class="modal-body" id="accountDataContent"></div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="closeAccountDataBtn2">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal confirm-modal" id="confirmModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
                    <button class="modal-close" id="closeConfirmBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="confirmCancelBtn">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" id="confirmOkBtn">–û–ö</button>
                </div>
            </div>
        </div>

        <div class="modal form-modal" id="createChannelModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</span>
                    <button class="modal-close" id="closeCreateChannelBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="channelName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                        <input type="text" id="channelName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                    </div>
                    <div class="form-group">
                        <label for="channelDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="channelDescription" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelCreateChannelBtn">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" id="createChannelBtn">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal form-modal" id="createGroupModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</span>
                    <button class="modal-close" id="closeCreateGroupBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="groupName">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                        <input type="text" id="groupName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                    </div>
                    <div class="form-group">
                        <label for="groupDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="groupDescription" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelCreateGroupBtn">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" id="createGroupBtn">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal confirm-modal" id="joinModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span id="joinTitle">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</span>
                    <button class="modal-close" id="closeJoinBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="joinMessage">–í—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="joinCancelBtn">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" id="joinOkBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                </div>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
        <div class="notification" id="notification"></div>
    </div>

    <script type="module">
        // –í–µ—Å—å JavaScript –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // –ò–º–ø–æ—Ä—Ç Firebase –∏ –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥...
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, set, push, onChildAdded, query, orderByChild, equalTo, get, onValue, remove, update, child, limitToLast } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDdey6ZroD4KsiPiD2dnVfQe3I3OW3MPV8",
            authDomain: "max-chat-f9319.firebaseapp.com",
            databaseURL: "https://max-chat-f9319-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "max-chat-f9319",
            storageBucket: "max-chat-f9319.firebasestorage.app",
            messagingSenderId: "1013158224179",
            appId: "1:1013158224179:web:c4a052ca2e86034de59e46"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let currentUser = null;
        let selectedUser = null;
        let selectedChannel = null;
        let selectedGroup = null;
        let allUsers = [];
        let allChannels = [];
        let allGroups = [];
        
        const elements = {
            screens: document.querySelectorAll('.screen'),
            bottomNav: document.getElementById('bottomNav'),
            notification: document.getElementById('notification'),
            accountDataModal: document.getElementById('accountDataModal'),
            accountDataContent: document.getElementById('accountDataContent'),
            confirmModal: document.getElementById('confirmModal'),
            createChannelModal: document.getElementById('createChannelModal'),
            createGroupModal: document.getElementById('createGroupModal'),
            joinModal: document.getElementById('joinModal'),
            confirmTitle: document.getElementById('confirmTitle'),
            confirmMessage: document.getElementById('confirmMessage'),
            confirmOkBtn: document.getElementById('confirmOkBtn'),
            confirmCancelBtn: document.getElementById('confirmCancelBtn'),
            closeConfirmBtn: document.getElementById('closeConfirmBtn'),
            channelName: document.getElementById('channelName'),
            channelDescription: document.getElementById('channelDescription'),
            createChannelBtn: document.getElementById('createChannelBtn'),
            cancelCreateChannelBtn: document.getElementById('cancelCreateChannelBtn'),
            closeCreateChannelBtn: document.getElementById('closeCreateChannelBtn'),
            groupName: document.getElementById('groupName'),
            groupDescription: document.getElementById('groupDescription'),
            createGroupBtn: document.getElementById('createGroupBtn'),
            cancelCreateGroupBtn: document.getElementById('cancelCreateGroupBtn'),
            closeCreateGroupBtn: document.getElementById('closeCreateGroupBtn'),
            joinTitle: document.getElementById('joinTitle'),
            joinMessage: document.getElementById('joinMessage'),
            joinOkBtn: document.getElementById('joinOkBtn'),
            joinCancelBtn: document.getElementById('joinCancelBtn'),
            closeJoinBtn: document.getElementById('closeJoinBtn'),
            usernameDisplay: document.getElementById('usernameDisplay'),
            appTitle: document.getElementById('appTitle'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            themeIcon: document.getElementById('themeIcon'),
            backFromGlobalBtn: document.getElementById('backFromGlobalBtn'),
            backFromChannelBtn: document.getElementById('backFromChannelBtn'),
            backFromGroupBtn: document.getElementById('backFromGroupBtn'),
            backFromPrivateBtn: document.getElementById('backFromPrivateBtn'),
            closeAccountDataBtn: document.getElementById('closeAccountDataBtn'),
            closeAccountDataBtn2: document.getElementById('closeAccountDataBtn2'),
            menuItems: document.querySelectorAll('.menu-item'),
            navItems: document.querySelectorAll('.nav-item'),
            themeOptions: document.querySelectorAll('.theme-option'),
            loginBtn: document.getElementById('loginBtn'),
            registerBtn: document.getElementById('registerBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            saveUsernameBtn: document.getElementById('saveUsernameBtn'),
            contactSupportBtn: document.getElementById('contactSupportBtn'),
            showAccountDataBtn: document.getElementById('showAccountDataBtn'),
            sendGlobalMessage: document.getElementById('sendGlobalMessage'),
            sendChannelMessage: document.getElementById('sendChannelMessage'),
            sendGroupMessage: document.getElementById('sendGroupMessage'),
            sendPrivateMessage: document.getElementById('sendPrivateMessage'),
            globalMessageInput: document.getElementById('globalMessageInput'),
            channelMessageInput: document.getElementById('channelMessageInput'),
            groupMessageInput: document.getElementById('groupMessageInput'),
            privateMessageInput: document.getElementById('privateMessageInput'),
            searchUser: document.getElementById('searchUser'),
            searchChannel: document.getElementById('searchChannel'),
            searchGroup: document.getElementById('searchGroup'),
            loginUsername: document.getElementById('loginUsername'),
            loginPassword: document.getElementById('loginPassword'),
            regUsername: document.getElementById('regUsername'),
            regSearchUsername: document.getElementById('regSearchUsername'),
            regEmail: document.getElementById('regEmail'),
            regPassword: document.getElementById('regPassword'),
            changeUsername: document.getElementById('changeUsername'),
            showRegister: document.getElementById('showRegister'),
            showLogin: document.getElementById('showLogin'),
            globalUsersCount: document.getElementById('globalUsersCount'),
            channelMembers: document.getElementById('channelMembers'),
            groupMembers: document.getElementById('groupMembers'),
            channelTitle: document.getElementById('channelTitle'),
            groupTitle: document.getElementById('groupTitle'),
            privateChatTitle: document.getElementById('privateChatTitle'),
            globalMessages: document.getElementById('globalMessages'),
            channelMessages: document.getElementById('channelMessages'),
            groupMessages: document.getElementById('groupMessages'),
            privateMessages: document.getElementById('privateMessages'),
            usersList: document.getElementById('usersList'),
            channelsList: document.getElementById('channelsList'),
            groupsList: document.getElementById('groupsList')
        };
        
        const utils = {
            showNotification(message, type = 'success') {
                elements.notification.textContent = message;
                elements.notification.className = `notification ${type}`;
                elements.notification.style.display = 'block';
                
                setTimeout(() => {
                    elements.notification.style.display = 'none';
                }, 3000);
            },
            
            showScreen(screenName) {
                elements.screens.forEach(screen => {
                    screen.classList.remove('active');
                });
                
                const screen = document.getElementById(screenName + 'Screen');
                if (screen) {
                    screen.classList.add('active');
                }
                
                elements.navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-screen') === screenName) {
                        item.classList.add('active');
                    }
                });
            },
            
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                }
            },
            
            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            },
            
            showConfirm(title, message, onConfirm, onCancel = null) {
                elements.confirmTitle.textContent = title;
                elements.confirmMessage.textContent = message;
                
                const handleConfirm = () => {
                    elements.confirmOkBtn.removeEventListener('click', handleConfirm);
                    if (onCancel) {
                        elements.confirmCancelBtn.removeEventListener('click', handleCancel);
                    }
                    utils.hideModal('confirmModal');
                    onConfirm();
                };
                
                const handleCancel = () => {
                    elements.confirmOkBtn.removeEventListener('click', handleConfirm);
                    elements.confirmCancelBtn.removeEventListener('click', handleCancel);
                    utils.hideModal('confirmModal');
                    if (onCancel) onCancel();
                };
                
                elements.confirmOkBtn.addEventListener('click', handleConfirm, { once: true });
                elements.confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
                elements.closeConfirmBtn.addEventListener('click', handleCancel, { once: true });
                
                utils.showModal('confirmModal');
            },
            
            showJoinPrompt(type, name, onJoin, onCancel = null) {
                elements.joinTitle.textContent = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ ${type}`;
                elements.joinMessage.textContent = `–í—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ "${name}"?`;
                
                const handleJoin = () => {
                    elements.joinOkBtn.removeEventListener('click', handleJoin);
                    if (onCancel) {
                        elements.joinCancelBtn.removeEventListener('click', handleCancel);
                    }
                    utils.hideModal('joinModal');
                    onJoin();
                };
                
                const handleCancel = () => {
                    elements.joinOkBtn.removeEventListener('click', handleJoin);
                    elements.joinCancelBtn.removeEventListener('click', handleCancel);
                    utils.hideModal('joinModal');
                    if (onCancel) onCancel();
                };
                
                elements.joinOkBtn.addEventListener('click', handleJoin, { once: true });
                elements.joinCancelBtn.addEventListener('click', handleCancel, { once: true });
                elements.closeJoinBtn.addEventListener('click', handleCancel, { once: true });
                
                utils.showModal('joinModal');
            },
            
            formatTime(timestamp) {
                try {
                    const date = new Date(timestamp);
                    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } catch (e) {
                    return '00:00';
                }
            },
            
            sanitizeInput(text) {
                if (!text) return '';
                return text
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    .replace(/\n/g, '<br>');
            },
            
            isOldBrowser() {
                const userAgent = navigator.userAgent.toLowerCase();
                return userAgent.includes('nokia') || 
                       userAgent.includes('symbian') ||
                       userAgent.includes('opera mini') ||
                       /msie|trident/.test(userAgent);
            },
            
            scrollToBottom(container) {
                if (container) {
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            },
            
            createEmptyState(icon, title, text, buttonText = null, onClick = null) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">${icon}</div>
                    <div class="empty-state-title">${title}</div>
                    <div class="empty-state-text">${text}</div>
                `;
                
                if (buttonText && onClick) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary';
                    button.textContent = buttonText;
                    button.addEventListener('click', onClick);
                    emptyState.appendChild(button);
                }
                
                return emptyState;
            }
        };
        
        // Firebase —Ñ—É–Ω–∫—Ü–∏–∏
        const firebaseFunctions = {
            async registerUser(username, searchUsername, email, password) {
                try {
                    const usersRef = ref(database, 'users');
                    const searchQuery = query(usersRef, orderByChild('searchUsername'), equalTo(searchUsername.toLowerCase()));
                    const snapshot = await get(searchQuery);
                    
                    if (snapshot.exists()) {
                        return { 
                            success: false, 
                            message: '–Æ–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç' 
                        };
                    }
                    
                    const userId = push(ref(database, 'users')).key;
                    const grant = ['durov', 'owner', 'support'].includes(searchUsername.toLowerCase());
                    
                    const userData = {
                        id: userId,
                        username: username,
                        searchUsername: searchUsername.toLowerCase(),
                        email: email.toLowerCase(),
                        password: password,
                        grant: grant,
                        createdAt: Date.now(),
                        online: true,
                        lastSeen: Date.now()
                    };
                    
                    await set(ref(database, `users/${userId}`), userData);
                    
                    return { success: true, user: userData };
                } catch (error) {
                    console.error('Registration error:', error);
                    return { success: false, message: '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' };
                }
            },
            
            async loginUser(identifier, password) {
                try {
                    const usersRef = ref(database, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (!snapshot.exists()) {
                        return { success: false, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' };
                    }
                    
                    let foundUser = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        if ((user.username === identifier || 
                             user.email === identifier.toLowerCase() || 
                             user.searchUsername === identifier.toLowerCase()) && 
                            user.password === password) {
                            foundUser = user;
                        }
                    });
                    
                    if (foundUser) {
                        await update(ref(database, `users/${foundUser.id}`), {
                            online: true,
                            lastSeen: Date.now()
                        });
                        
                        return { success: true, user: foundUser };
                    } else {
                        return { success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å' };
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    return { success: false, message: '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞' };
                }
            },
            
            loadUsers(callback) {
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const users = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const user = childSnapshot.val();
                            users.push(user);
                        });
                    }
                    allUsers = users;
                    callback(users);
                });
            },
            
            loadChannels(callback) {
                const channelsRef = ref(database, 'channels');
                onValue(channelsRef, (snapshot) => {
                    const channels = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const channel = childSnapshot.val();
                            channels.push(channel);
                        });
                    }
                    allChannels = channels;
                    callback(channels);
                });
            },
            
            loadGroups(callback) {
                const groupsRef = ref(database, 'groups');
                onValue(groupsRef, (snapshot) => {
                    const groups = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const group = childSnapshot.val();
                            groups.push(group);
                        });
                    }
                    allGroups = groups;
                    callback(groups);
                });
            },
            
            subscribeToGlobalMessages(callback) {
                const messagesRef = ref(database, 'globalMessages');
                const messagesQuery = query(messagesRef, orderByChild('timestamp'));
                
                return onChildAdded(messagesQuery, (snapshot) => {
                    const message = snapshot.val();
                    callback(message);
                });
            },
            
            subscribeToChannelMessages(channelId, callback) {
                const messagesRef = ref(database, `channelMessages/${channelId}`);
                const messagesQuery = query(messagesRef, orderByChild('timestamp'));
                
                return onChildAdded(messagesQuery, (snapshot) => {
                    const message = snapshot.val();
                    callback(message);
                });
            },
            
            subscribeToGroupMessages(groupId, callback) {
                const messagesRef = ref(database, `groupMessages/${groupId}`);
                const messagesQuery = query(messagesRef, orderByChild('timestamp'));
                
                return onChildAdded(messagesQuery, (snapshot) => {
                    const message = snapshot.val();
                    callback(message);
                });
            },
            
            subscribeToPrivateMessages(userId, otherUserId, callback) {
                const chatId = [userId, otherUserId].sort().join('_');
                const messagesRef = ref(database, `privateMessages/${chatId}`);
                const messagesQuery = query(messagesRef, orderByChild('timestamp'));
                
                return onChildAdded(messagesQuery, (snapshot) => {
                    const message = snapshot.val();
                    callback(message);
                });
            },
            
            sendGlobalMessage(message, user) {
                try {
                    const messagesRef = ref(database, 'globalMessages');
                    const newMessageRef = push(messagesRef);
                    
                    const messageData = {
                        id: newMessageRef.key,
                        userId: user.id,
                        username: user.username,
                        searchUsername: user.searchUsername,
                        text: message,
                        timestamp: Date.now(),
                        grant: user.grant || false
                    };
                    
                    set(newMessageRef, messageData);
                    return true;
                } catch (error) {
                    console.error('Send global message error:', error);
                    return false;
                }
            },
            
            sendChannelMessage(channelId, message, user) {
                try {
                    const messagesRef = ref(database, `channelMessages/${channelId}`);
                    const newMessageRef = push(messagesRef);
                    
                    const messageData = {
                        id: newMessageRef.key,
                        userId: user.id,
                        username: user.username,
                        text: message,
                        timestamp: Date.now(),
                        grant: user.grant || false
                    };
                    
                    set(newMessageRef, messageData);
                    return true;
                } catch (error) {
                    console.error('Send channel message error:', error);
                    return false;
                }
            },
            
            sendGroupMessage(groupId, message, user) {
                try {
                    const messagesRef = ref(database, `groupMessages/${groupId}`);
                    const newMessageRef = push(messagesRef);
                    
                    const messageData = {
                        id: newMessageRef.key,
                        userId: user.id,
                        username: user.username,
                        text: message,
                        timestamp: Date.now(),
                        grant: user.grant || false
                    };
                    
                    set(newMessageRef, messageData);
                    return true;
                } catch (error) {
                    console.error('Send group message error:', error);
                    return false;
                }
            },
            
            sendPrivateMessage(fromUser, toUser, message) {
                try {
                    const chatId = [fromUser.id, toUser.id].sort().join('_');
                    const messagesRef = ref(database, `privateMessages/${chatId}`);
                    const newMessageRef = push(messagesRef);
                    
                    const messageData = {
                        id: newMessageRef.key,
                        fromUserId: fromUser.id,
                        fromUsername: fromUser.username,
                        fromGrant: fromUser.grant || false,
                        toUserId: toUser.id,
                        toUsername: toUser.username,
                        text: message,
                        timestamp: Date.now()
                    };
                    
                    set(newMessageRef, messageData);
                    
                    return true;
                } catch (error) {
                    console.error('Send private message error:', error);
                    return false;
                }
            },
            
            updateOnlineStatus(userId, status) {
                if (!userId) return;
                update(ref(database, `users/${userId}`), {
                    online: status,
                    lastSeen: Date.now()
                });
            },
            
            async joinChannel(channelId, user) {
                try {
                    const channelRef = ref(database, `channels/${channelId}/members/${user.id}`);
                    await set(channelRef, {
                        username: user.username,
                        searchUsername: user.searchUsername,
                        joinedAt: Date.now(),
                        isCreator: false
                    });
                    
                    const channelSnapshot = await get(ref(database, `channels/${channelId}`));
                    if (channelSnapshot.exists()) {
                        const channel = channelSnapshot.val();
                        const memberCount = Object.keys(channel.members || {}).length;
                        await update(ref(database, `channels/${channelId}`), {
                            memberCount: memberCount
                        });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Join channel error:', error);
                    return false;
                }
            },
            
            async joinGroup(groupId, user) {
                try {
                    const groupRef = ref(database, `groups/${groupId}/members/${user.id}`);
                    await set(groupRef, {
                        username: user.username,
                        searchUsername: user.searchUsername,
                        joinedAt: Date.now(),
                        isAdmin: false
                    });
                    
                    const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                    if (groupSnapshot.exists()) {
                        const group = groupSnapshot.val();
                        const memberCount = Object.keys(group.members || {}).length;
                        await update(ref(database, `groups/${groupId}`), {
                            memberCount: memberCount
                        });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Join group error:', error);
                    return false;
                }
            },
            
            async createChannel(name, description, creator) {
                try {
                    const channelsRef = ref(database, 'channels');
                    const channelId = push(channelsRef).key;
                    
                    const channelData = {
                        id: channelId,
                        name: name,
                        description: description || '',
                        creatorId: creator.id,
                        creatorName: creator.username,
                        creatorSearchUsername: creator.searchUsername,
                        createdAt: Date.now(),
                        members: {
                            [creator.id]: {
                                username: creator.username,
                                searchUsername: creator.searchUsername,
                                joinedAt: Date.now(),
                                isCreator: true
                            }
                        },
                        memberCount: 1,
                        type: 'channel'
                    };
                    
                    await set(ref(database, `channels/${channelId}`), channelData);
                    
                    return { success: true, channel: channelData };
                } catch (error) {
                    console.error('Create channel error:', error);
                    return { success: false, message: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞' };
                }
            },
            
            async createGroup(name, description, creator) {
                try {
                    const groupsRef = ref(database, 'groups');
                    const groupId = push(groupsRef).key;
                    
                    const groupData = {
                        id: groupId,
                        name: name,
                        description: description || '',
                        creatorId: creator.id,
                        creatorName: creator.username,
                        creatorSearchUsername: creator.searchUsername,
                        createdAt: Date.now(),
                        members: {
                            [creator.id]: {
                                username: creator.username,
                                searchUsername: creator.searchUsername,
                                joinedAt: Date.now(),
                                isAdmin: true
                            }
                        },
                        memberCount: 1,
                        admins: [creator.id],
                        type: 'group'
                    };
                    
                    await set(ref(database, `groups/${groupId}`), groupData);
                    
                    return { success: true, group: groupData };
                } catch (error) {
                    console.error('Create group error:', error);
                    return { success: false, message: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã' };
                }
            },
            
            async getChannelMessages(channelId) {
                try {
                    const messagesRef = ref(database, `channelMessages/${channelId}`);
                    const snapshot = await get(query(messagesRef, orderByChild('timestamp'), limitToLast(50)));
                    
                    if (snapshot.exists()) {
                        const messages = [];
                        snapshot.forEach((childSnapshot) => {
                            messages.push(childSnapshot.val());
                        });
                        return messages;
                    }
                    return [];
                } catch (error) {
                    console.error('Get channel messages error:', error);
                    return [];
                }
            },
            
            async getGroupMessages(groupId) {
                try {
                    const messagesRef = ref(database, `groupMessages/${groupId}`);
                    const snapshot = await get(query(messagesRef, orderByChild('timestamp'), limitToLast(50)));
                    
                    if (snapshot.exists()) {
                        const messages = [];
                        snapshot.forEach((childSnapshot) => {
                            messages.push(childSnapshot.val());
                        });
                        return messages;
                    }
                    return [];
                } catch (error) {
                    console.error('Get group messages error:', error);
                    return [];
                }
            },
            
            async getPrivateMessages(userId, otherUserId) {
                try {
                    const chatId = [userId, otherUserId].sort().join('_');
                    const messagesRef = ref(database, `privateMessages/${chatId}`);
                    const snapshot = await get(query(messagesRef, orderByChild('timestamp'), limitToLast(50)));
                    
                    if (snapshot.exists()) {
                        const messages = [];
                        snapshot.forEach((childSnapshot) => {
                            messages.push(childSnapshot.val());
                        });
                        return messages;
                    }
                    return [];
                } catch (error) {
                    console.error('Get private messages error:', error);
                    return [];
                }
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        class EventHandlers {
            constructor() {
                this.unsubscribes = {
                    global: null,
                    channel: null,
                    group: null,
                    private: null
                };
            }
            
            init() {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                
                // –£–ë–†–ê–ù–ê –ü–†–û–í–ï–†–ö–ê –ù–ê –°–¢–ê–†–´–ï –ë–†–ê–£–ó–ï–†–´ –ò –ñ–Å–õ–¢–ê–Ø –ü–õ–ê–®–ö–ê
                
                this.loadTheme();
                
                const savedUser = localStorage.getItem('collapsChatUser');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        this.showMainApp();
                    } catch (e) {
                        localStorage.removeItem('collapsChatUser');
                    }
                }
                
                this.setupEventListeners();
                this.loadData();
                this.setupMobileFeatures();
            }
            
            setupEventListeners() {
                // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                elements.menuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const screen = item.getAttribute('data-screen');
                        utils.showScreen(screen);
                    });
                });
                
                elements.navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const screen = item.getAttribute('data-screen');
                        utils.showScreen(screen);
                    });
                });
                
                // –ö–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
                elements.backFromGlobalBtn.addEventListener('click', () => utils.showScreen('mainMenu'));
                elements.backFromChannelBtn.addEventListener('click', () => utils.showScreen('channels'));
                elements.backFromGroupBtn.addEventListener('click', () => utils.showScreen('groups'));
                elements.backFromPrivateBtn.addEventListener('click', () => utils.showScreen('privateChats'));
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                elements.closeAccountDataBtn.addEventListener('click', () => utils.hideModal('accountDataModal'));
                elements.closeAccountDataBtn2.addEventListener('click', () => utils.hideModal('accountDataModal'));
                
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                elements.loginBtn.addEventListener('click', () => this.handleLogin());
                elements.registerBtn.addEventListener('click', () => this.handleRegister());
                elements.logoutBtn.addEventListener('click', () => this.handleLogout());
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                elements.saveUsernameBtn.addEventListener('click', () => this.changeUsername());
                elements.contactSupportBtn.addEventListener('click', () => this.contactSupport());
                elements.showAccountDataBtn.addEventListener('click', () => this.showAccountData());
                
                // –°–º–µ–Ω–∞ —Ç–µ–º—ã
                elements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                elements.themeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.getAttribute('data-theme');
                        this.setTheme(theme);
                    });
                });
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
                elements.sendGlobalMessage.addEventListener('click', () => this.sendGlobalMessage());
                elements.sendPrivateMessage.addEventListener('click', () => this.sendPrivateMessage());
                elements.sendChannelMessage.addEventListener('click', () => this.sendChannelMessage());
                elements.sendGroupMessage.addEventListener('click', () => this.sendGroupMessage());
                
                // –ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
                elements.globalMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendGlobalMessage();
                });
                elements.privateMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendPrivateMessage();
                });
                elements.channelMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChannelMessage();
                });
                elements.groupMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendGroupMessage();
                });
                
                // –ü–æ–∏—Å–∫
                elements.searchUser.addEventListener('input', (e) => this.filterUsers(e.target.value));
                elements.searchChannel.addEventListener('input', (e) => this.filterChannels(e.target.value));
                elements.searchGroup.addEventListener('input', (e) => this.filterGroups(e.target.value));
                
                // –°—Å—ã–ª–∫–∏ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
                elements.showRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    utils.showScreen('register');
                });
                elements.showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    utils.showScreen('login');
                });
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
                elements.createChannelBtn.addEventListener('click', () => this.createChannel());
                elements.cancelCreateChannelBtn.addEventListener('click', () => utils.hideModal('createChannelModal'));
                elements.closeCreateChannelBtn.addEventListener('click', () => utils.hideModal('createChannelModal'));
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
                elements.createGroupBtn.addEventListener('click', () => this.createGroup());
                elements.cancelCreateGroupBtn.addEventListener('click', () => utils.hideModal('createGroupModal'));
                elements.closeCreateGroupBtn.addEventListener('click', () => utils.hideModal('createGroupModal'));
                
                // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                window.addEventListener('beforeunload', () => {
                    if (currentUser) {
                        firebaseFunctions.updateOnlineStatus(currentUser.id, false);
                    }
                });
                
                // –£–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
                document.addEventListener('touchstart', () => {}, { passive: true });
            }
            
            setupMobileFeatures() {
                document.addEventListener('touchmove', (e) => {
                    if (e.scale !== 1) e.preventDefault();
                }, { passive: false });
                
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    document.body.classList.add('mobile');
                }
            }
            
            loadTheme() {
                const savedTheme = localStorage.getItem('collapsChatTheme') || 'light';
                this.setTheme(savedTheme);
            }
            
            setTheme(themeName) {
                document.documentElement.setAttribute('data-theme', themeName);
                localStorage.setItem('collapsChatTheme', themeName);
                
                elements.themeOptions.forEach(option => {
                    option.classList.remove('active');
                    if (option.getAttribute('data-theme') === themeName) {
                        option.classList.add('active');
                    }
                });
                
                const isDark = themeName.includes('dark');
                elements.themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
            
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const themes = ['light', 'light-alt', 'dark', 'dark-alt'];
                const currentIndex = themes.indexOf(currentTheme);
                const nextIndex = (currentIndex + 1) % themes.length;
                this.setTheme(themes[nextIndex]);
            }
            
            loadData() {
                firebaseFunctions.loadUsers((users) => {
                    this.displayUsers(users);
                    this.updateOnlineCount(users);
                });
                
                firebaseFunctions.loadChannels((channels) => {
                    this.displayChannels(channels);
                });
                
                firebaseFunctions.loadGroups((groups) => {
                    this.displayGroups(groups);
                });
                
                firebaseFunctions.subscribeToGlobalMessages((message) => {
                    this.addGlobalMessage(message);
                });
                
                setInterval(() => {
                    if (currentUser) {
                        firebaseFunctions.updateOnlineStatus(currentUser.id, true);
                    }
                }, 30000);
            }
            
            async handleLogin() {
                const identifier = elements.loginUsername.value.trim();
                const password = elements.loginPassword.value.trim();
                
                if (!identifier || !password) {
                    utils.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const result = await firebaseFunctions.loginUser(identifier, password);
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('collapsChatUser', JSON.stringify(currentUser));
                    utils.showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                    this.showMainApp();
                } else {
                    utils.showNotification(result.message, 'error');
                }
            }
            
            async handleRegister() {
                const username = elements.regUsername.value.trim();
                const searchUsername = elements.regSearchUsername.value.trim().toLowerCase();
                const email = elements.regEmail.value.trim();
                const password = elements.regPassword.value.trim();
                
                if (!username || !searchUsername || !email || !password) {
                    utils.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                if (!/^[a-zA-Z0-9_]+$/.test(searchUsername)) {
                    utils.showNotification('–Æ–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞: —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    utils.showNotification('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                    return;
                }
                
                const result = await firebaseFunctions.registerUser(username, searchUsername, email, password);
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('collapsChatUser', JSON.stringify(currentUser));
                    utils.showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                    this.showMainApp();
                } else {
                    utils.showNotification(result.message, 'error');
                }
            }
            
            handleLogout() {
                utils.showConfirm(
                    '–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?',
                    () => {
                        if (currentUser) {
                            firebaseFunctions.updateOnlineStatus(currentUser.id, false);
                        }
                        
                        currentUser = null;
                        selectedUser = null;
                        selectedChannel = null;
                        selectedGroup = null;
                        
                        localStorage.removeItem('collapsChatUser');
                        utils.showScreen('login');
                        elements.bottomNav.style.display = 'none';
                        elements.usernameDisplay.textContent = '–ì–æ—Å—Ç—å';
                        
                        elements.globalMessages.innerHTML = '';
                        elements.privateMessages.innerHTML = '';
                        elements.channelMessages.innerHTML = '';
                        elements.groupMessages.innerHTML = '';
                        
                        utils.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                    }
                );
            }
            
            changeUsername() {
                const newUsername = elements.changeUsername.value.trim();
                
                if (!newUsername) {
                    utils.showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º', 'error');
                    return;
                }
                
                utils.showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'warning');
            }
            
            contactSupport() {
                const supportUser = allUsers.find(u => u.searchUsername === 'support');
                if (supportUser) {
                    this.selectUser(supportUser);
                    utils.showNotification('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–¥–¥–µ—Ä–∂–∫–µ');
                } else {
                    utils.showNotification('–ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
            }
            
            showAccountData() {
                if (!currentUser) return;
                
                const html = `
                    <div style="line-height: 1.6;">
                        <p><strong>ID:</strong> ${currentUser.id}</p>
                        <p><strong>–ù–∏–∫–Ω–µ–π–º:</strong> ${currentUser.username}</p>
                        <p><strong>–Æ–∑–µ—Ä–Ω–µ–π–º:</strong> @${currentUser.searchUsername}</p>
                        <p><strong>Email:</strong> ${currentUser.email}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${currentUser.grant ? '–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω ‚úì' : '–û–±—ã—á–Ω—ã–π'}</p>
                        <p><strong>–û–Ω–ª–∞–π–Ω:</strong> ${currentUser.online ? '–î–∞' : '–ù–µ—Ç'}</p>
                        <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${new Date(currentUser.createdAt).toLocaleDateString()}</p>
                    </div>
                `;
                
                elements.accountDataContent.innerHTML = html;
                utils.showModal('accountDataModal');
            }
            
            showMainApp() {
                elements.bottomNav.style.display = 'flex';
                elements.usernameDisplay.textContent = currentUser.username;
                utils.showScreen('mainMenu');
                
                firebaseFunctions.updateOnlineStatus(currentUser.id, true);
            }
            
            updateOnlineCount(users) {
                if (!currentUser) return;
                const onlineCount = users.filter(u => u.online).length;
                elements.globalUsersCount.textContent = `${onlineCount} –æ–Ω–ª–∞–π–Ω`;
            }
            
            displayUsers(users) {
                elements.usersList.innerHTML = '';
                
                const filteredUsers = users.filter(user => 
                    !currentUser || user.id !== currentUser.id
                );
                
                if (filteredUsers.length === 0) {
                    elements.usersList.appendChild(
                        utils.createEmptyState(
                            'üë§',
                            '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
                            '–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å',
                            '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞',
                            () => utils.showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'warning')
                        )
                    );
                    return;
                }
                
                filteredUsers.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="list-item-icon">üë§</div>
                        <div class="list-item-content">
                            <div class="list-item-title">
                                ${user.username}
                                ${user.grant ? '<span class="verified-badge"></span>' : ''}
                            </div>
                            <div class="list-item-subtitle">@${user.searchUsername}</div>
                            <div class="list-item-meta">
                                <span class="${user.online ? 'status-online' : 'status-offline'}">‚óè</span>
                                ${user.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω'}
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.selectUser(user);
                    });
                    
                    elements.usersList.appendChild(item);
                });
            }
            
            displayChannels(channels) {
                elements.channelsList.innerHTML = '';
                
                if (channels.length === 0) {
                    elements.channelsList.appendChild(
                        utils.createEmptyState(
                            'üì¢',
                            '–ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤',
                            '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∫–∞–Ω–∞–ª –¥–ª—è –æ–±—â–µ–Ω–∏—è',
                            '–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª',
                            () => this.showCreateChannelModal()
                        )
                    );
                    return;
                }
                
                channels.forEach(channel => {
                    const isMember = channel.members && currentUser && channel.members[currentUser.id];
                    
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="list-item-icon">üì¢</div>
                        <div class="list-item-content">
                            <div class="list-item-title">${channel.name}</div>
                            <div class="list-item-subtitle">${channel.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                            <div class="list-item-meta">
                                ${channel.memberCount || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Ä¢ ${channel.creatorName}
                                ${isMember ? '‚Ä¢ <span style="color: var(--success-color);">–í—ã —É—á–∞—Å—Ç–Ω–∏–∫</span>' : ''}
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.selectChannel(channel);
                    });
                    
                    elements.channelsList.appendChild(item);
                });
            }
            
            displayGroups(groups) {
                elements.groupsList.innerHTML = '';
                
                if (groups.length === 0) {
                    elements.groupsList.appendChild(
                        utils.createEmptyState(
                            'üë•',
                            '–ù–µ—Ç –≥—Ä—É–ø–ø',
                            '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É –¥–ª—è –æ–±—â–µ–Ω–∏—è',
                            '–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É',
                            () => this.showCreateGroupModal()
                        )
                    );
                    return;
                }
                
                groups.forEach(group => {
                    const isMember = group.members && currentUser && group.members[currentUser.id];
                    
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="list-item-icon">üë•</div>
                        <div class="list-item-content">
                            <div class="list-item-title">${group.name}</div>
                            <div class="list-item-subtitle">${group.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                            <div class="list-item-meta">
                                ${group.memberCount || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Ä¢ ${group.creatorName}
                                ${isMember ? '‚Ä¢ <span style="color: var(--success-color);">–í—ã —É—á–∞—Å—Ç–Ω–∏–∫</span>' : ''}
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.selectGroup(group);
                    });
                    
                    elements.groupsList.appendChild(item);
                });
            }
            
            filterUsers(searchTerm) {
                const items = elements.usersList.querySelectorAll('.list-item');
                searchTerm = searchTerm.toLowerCase();
                
                items.forEach(item => {
                    const title = item.querySelector('.list-item-title').textContent.toLowerCase();
                    const subtitle = item.querySelector('.list-item-subtitle').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            filterChannels(searchTerm) {
                const items = elements.channelsList.querySelectorAll('.list-item');
                searchTerm = searchTerm.toLowerCase();
                
                items.forEach(item => {
                    const title = item.querySelector('.list-item-title').textContent.toLowerCase();
                    const subtitle = item.querySelector('.list-item-subtitle').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            filterGroups(searchTerm) {
                const items = elements.groupsList.querySelectorAll('.list-item');
                searchTerm = searchTerm.toLowerCase();
                
                items.forEach(item => {
                    const title = item.querySelector('.list-item-title').textContent.toLowerCase();
                    const subtitle = item.querySelector('.list-item-subtitle').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            async selectUser(user) {
                selectedUser = user;
                elements.privateChatTitle.textContent = `üí≠ ${user.username}`;
                elements.privateMessages.innerHTML = '';
                utils.showScreen('privateChat');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                const messages = await firebaseFunctions.getPrivateMessages(currentUser.id, user.id);
                messages.forEach(message => {
                    this.addPrivateMessage(message);
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (this.unsubscribes.private) {
                    this.unsubscribes.private();
                }
                
                this.unsubscribes.private = firebaseFunctions.subscribeToPrivateMessages(
                    currentUser.id,
                    user.id,
                    (message) => {
                        this.addPrivateMessage(message);
                    }
                );
            }
            
            async selectChannel(channel) {
                selectedChannel = channel;
                elements.channelTitle.textContent = `üì¢ ${channel.name}`;
                elements.channelMembers.textContent = `${channel.memberCount || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                elements.channelMessages.innerHTML = '';
                utils.showScreen('channelChat');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–Ω–∏–∫ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const isMember = channel.members && currentUser && channel.members[currentUser.id];
                
                if (!isMember && currentUser) {
                    utils.showJoinPrompt(
                        '–∫–∞–Ω–∞–ª—É',
                        channel.name,
                        async () => {
                            await firebaseFunctions.joinChannel(channel.id, currentUser);
                            utils.showNotification('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–∞–Ω–∞–ª—É');
                            this.loadChannelData(channel.id);
                        },
                        () => {
                            utils.showScreen('channels');
                        }
                    );
                    return;
                }
                
                this.loadChannelData(channel.id);
            }
            
            async loadChannelData(channelId) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                const messages = await firebaseFunctions.getChannelMessages(channelId);
                messages.forEach(message => {
                    this.addChannelMessage(message);
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (this.unsubscribes.channel) {
                    this.unsubscribes.channel();
                }
                
                this.unsubscribes.channel = firebaseFunctions.subscribeToChannelMessages(
                    channelId,
                    (message) => {
                        this.addChannelMessage(message);
                    }
                );
            }
            
            async selectGroup(group) {
                selectedGroup = group;
                elements.groupTitle.textContent = `üë• ${group.name}`;
                elements.groupMembers.textContent = `${group.memberCount || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                elements.groupMessages.innerHTML = '';
                utils.showScreen('groupChat');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–Ω–∏–∫ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const isMember = group.members && currentUser && group.members[currentUser.id];
                
                if (!isMember && currentUser) {
                    utils.showJoinPrompt(
                        '–≥—Ä—É–ø–ø–µ',
                        group.name,
                        async () => {
                            await firebaseFunctions.joinGroup(group.id, currentUser);
                            utils.showNotification('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –≥—Ä—É–ø–ø–µ');
                            this.loadGroupData(group.id);
                        },
                        () => {
                            utils.showScreen('groups');
                        }
                    );
                    return;
                }
                
                this.loadGroupData(group.id);
            }
            
            async loadGroupData(groupId) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                const messages = await firebaseFunctions.getGroupMessages(groupId);
                messages.forEach(message => {
                    this.addGroupMessage(message);
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (this.unsubscribes.group) {
                    this.unsubscribes.group();
                }
                
                this.unsubscribes.group = firebaseFunctions.subscribeToGroupMessages(
                    groupId,
                    (message) => {
                        this.addGroupMessage(message);
                    }
                );
            }
            
            showCreateChannelModal() {
                if (!currentUser) {
                    utils.showNotification('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                    return;
                }
                
                elements.channelName.value = '';
                elements.channelDescription.value = '';
                utils.showModal('createChannelModal');
            }
            
            async createChannel() {
                const name = elements.channelName.value.trim();
                const description = elements.channelDescription.value.trim();
                
                if (!name) {
                    utils.showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞', 'error');
                    return;
                }
                
                const result = await firebaseFunctions.createChannel(name, description, currentUser);
                
                if (result.success) {
                    utils.hideModal('createChannelModal');
                    utils.showNotification('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    utils.showNotification(result.message, 'error');
                }
            }
            
            showCreateGroupModal() {
                if (!currentUser) {
                    utils.showNotification('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                    return;
                }
                
                elements.groupName.value = '';
                elements.groupDescription.value = '';
                utils.showModal('createGroupModal');
            }
            
            async createGroup() {
                const name = elements.groupName.value.trim();
                const description = elements.groupDescription.value.trim();
                
                if (!name) {
                    utils.showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
                    return;
                }
                
                const result = await firebaseFunctions.createGroup(name, description, currentUser);
                
                if (result.success) {
                    utils.hideModal('createGroupModal');
                    utils.showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    utils.showNotification(result.message, 'error');
                }
            }
            
            sendGlobalMessage() {
                const message = elements.globalMessageInput.value.trim();
                if (!message || !currentUser) return;
                
                const success = firebaseFunctions.sendGlobalMessage(message, currentUser);
                if (success) {
                    elements.globalMessageInput.value = '';
                }
            }
            
            sendPrivateMessage() {
                const message = elements.privateMessageInput.value.trim();
                if (!message || !currentUser || !selectedUser) return;
                
                const success = firebaseFunctions.sendPrivateMessage(currentUser, selectedUser, message);
                if (success) {
                    elements.privateMessageInput.value = '';
                }
            }
            
            sendChannelMessage() {
                const message = elements.channelMessageInput.value.trim();
                if (!message || !currentUser || !selectedChannel) return;
                
                const success = firebaseFunctions.sendChannelMessage(selectedChannel.id, message, currentUser);
                if (success) {
                    elements.channelMessageInput.value = '';
                } else {
                    utils.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            }
            
            sendGroupMessage() {
                const message = elements.groupMessageInput.value.trim();
                if (!message || !currentUser || !selectedGroup) return;
                
                const success = firebaseFunctions.sendGroupMessage(selectedGroup.id, message, currentUser);
                if (success) {
                    elements.groupMessageInput.value = '';
                } else {
                    utils.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            }
            
            addGlobalMessage(message) {
                const isCurrentUser = currentUser && message.userId === currentUser.id;
                const verifiedBadge = message.grant ? '<span class="verified-badge"></span>' : '';
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${utils.sanitizeInput(message.text)}</div>
                    <div class="message-info">
                        <span>${isCurrentUser ? '–í—ã' : message.username} ${verifiedBadge}</span>
                        <span>${utils.formatTime(message.timestamp)}</span>
                    </div>
                `;
                
                elements.globalMessages.appendChild(messageElement);
                utils.scrollToBottom(elements.globalMessages);
            }
            
            addChannelMessage(message) {
                const isCurrentUser = currentUser && message.userId === currentUser.id;
                const verifiedBadge = message.grant ? '<span class="verified-badge"></span>' : '';
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${utils.sanitizeInput(message.text)}</div>
                    <div class="message-info">
                        <span>${isCurrentUser ? '–í—ã' : message.username} ${verifiedBadge}</span>
                        <span>${utils.formatTime(message.timestamp)}</span>
                    </div>
                `;
                
                elements.channelMessages.appendChild(messageElement);
                utils.scrollToBottom(elements.channelMessages);
            }
            
            addGroupMessage(message) {
                const isCurrentUser = currentUser && message.userId === currentUser.id;
                const verifiedBadge = message.grant ? '<span class="verified-badge"></span>' : '';
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${utils.sanitizeInput(message.text)}</div>
                    <div class="message-info">
                        <span>${isCurrentUser ? '–í—ã' : message.username} ${verifiedBadge}</span>
                        <span>${utils.formatTime(message.timestamp)}</span>
                    </div>
                `;
                
                elements.groupMessages.appendChild(messageElement);
                utils.scrollToBottom(elements.groupMessages);
            }
            
            addPrivateMessage(message) {
                const isCurrentUser = currentUser && message.fromUserId === currentUser.id;
                const verifiedBadge = isCurrentUser ? 
                    (message.fromGrant ? '<span class="verified-badge"></span>' : '') :
                    (message.toGrant ? '<span class="verified-badge"></span>' : '');
                
                const username = isCurrentUser ? '–í—ã' : message.fromUsername;
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${utils.sanitizeInput(message.text)}</div>
                    <div class="message-info">
                        <span>${username} ${verifiedBadge}</span>
                        <span>${utils.formatTime(message.timestamp)}</span>
                    </div>
                `;
                
                elements.privateMessages.appendChild(messageElement);
                utils.scrollToBottom(elements.privateMessages);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            const eventHandlers = new EventHandlers();
            eventHandlers.init();
        });
    </script>
</body>
</html>